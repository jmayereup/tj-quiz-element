<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M6 Grammar Review Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<div id="quiz-m6-grammar-feedback-container">
    <!-- The component will be rendered here. -->
</div>

<template id="quiz-template-m6-grammar-feedback">
    <style>
        /* By setting display: block, we ensure the component takes up block-level space,
         * which is crucial for controlling width and layout. */
        :host {
            display: block;
            /* Removed fixed font-size to inherit from the blog page */
            --bg-light: #f1f5f9; /* slate-100 */
            --text-light: #1e293b; /* slate-800 */
            --card-bg-light: #ffffff; /* white */
            --card-shadow-light: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-light: #e2e8f0; /* slate-200 */
            --input-bg-light: #f8fafc; /* slate-50 */
            --input-border-light: #cbd5e1; /* slate-300 */
            --subtle-text-light: #475569; /* slate-600 */
            --primary-color: #4f46e5; /* indigo-600 */
            --primary-hover: #4338ca; /* indigo-700 */
            --primary-text: #ffffff;
            --green-color: #16a34a; /* green-600 */
            --green-hover: #15803d; /* green-700 */
            --green-light-bg: #dcfce7; /* green-100 */
            --red-color: #ef4444; /* red-500 */
            --red-light-bg: #fee2e2; /* red-100 */
            --yellow-color: #eab308; /* yellow-500 */
            --slate-color: #64748b; /* slate-500 */
            --slate-hover: #475569; /* slate-600 */
            --explanation-bg-light: #eef2ff; /* indigo-50 */
            --explanation-border-light: #c7d2fe; /* indigo-200 */
            --font-sans: 'Inter', sans-serif;
        }

        :host(.dark) {
            --bg-light: #0f172a; /* slate-900 */
            --text-light: #e2e8f0; /* slate-200 */
            --card-bg-light: #1e293b; /* slate-800 */
            --card-shadow-light: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --border-light: #334155; /* slate-700 */
            --input-bg-light: #334155; /* slate-700 */
            --input-border-light: #475569; /* slate-600 */
            --subtle-text-light: #94a3b8; /* slate-400 */
            --green-light-bg: #14532d; /* green-900 */
            --red-light-bg: #7f1d1d; /* red-900 */
            --explanation-bg-light: #312e81; /* indigo-900 */
            --explanation-border-light: #4338ca; /* indigo-700 */
        }

        .quiz-wrapper * {
            box-sizing: border-box;
        }
        
        .quiz-wrapper {
             font-family: var(--font-sans);
             background-color: var(--bg-light);
             color: var(--text-light);
             line-height: 1.5;
             transition: background-color 0.3s, color 0.3s;
             padding: 1rem 0;
        }

        .container {
            max-width: 720px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 1rem;
        }
        
        .quiz-card {
            background-color: var(--card-bg-light);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow-light);
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .quiz-header {
            background-color: var(--primary-color);
            color: var(--primary-text);
            padding: 1.5rem 1.5rem 2rem 1.5rem;
            position: relative;
        }
         .quiz-header h1 {
            font-size: 1.5em; 
            font-weight: 700;
            margin: 0;
         }
         .quiz-header p {
             margin-top: 0.5rem;
             color: #e0e7ff;
             opacity: 0.9;
             font-size: 0.9375em;
         }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25em;
        }
         .theme-toggle:hover {
             background-color: rgba(255, 255, 255, 0.2);
         }

        form {
            padding: 1.5rem;
        }
        
        @media (min-width: 640px) {
            form {
                padding: 2rem;
            }
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }
        
        #studentInfoSection, #postScoreActions {
            margin-bottom: 2rem;
        }
        
        legend {
            font-size: 1.125em;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            width: 100%;
            transition: color 0.3s, border-color 0.3s;
        }

        .question-block {
             padding-top: 1.5rem;
             border-top: 1px solid var(--border-light);
             transition: border-color 0.3s;
        }
        .question-block:first-of-type {
             border-top: none;
             padding-top: 0;
        }
         .question-block p {
             font-weight: 600;
             margin-bottom: 1rem;
             font-size: 1em;
         }
        
        .options-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .option-label {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: var(--input-bg-light);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
            border: 1px solid transparent;
            font-size: 0.9375em;
        }
        .option-label:hover {
            background-color: #e2e8f0;
        }
         :host(.dark) .option-label:hover {
            background-color: #334155;
        }

        .option-label.correct {
            background-color: var(--green-light-bg);
            border-color: var(--green-color);
        }
        .option-label.incorrect {
            background-color: var(--red-light-bg);
            border-color: var(--red-color);
        }
        .feedback-icon {
            margin-left: auto;
            font-size: 1.25em;
        }

        .explanation-box {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--explanation-bg-light);
            border: 1px solid var(--explanation-border-light);
            border-radius: 0.5rem;
            font-size: 0.875em;
            transition: all 0.3s;
        }

        .form-radio {
            width: 1.125em;
            height: 1.125em;
            margin-right: 0.75em;
            accent-color: var(--primary-color);
        }
         .form-radio:focus {
             box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
         }
         .form-radio:disabled {
             cursor: not-allowed;
         }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--input-bg-light);
            border: 1px solid var(--input-border-light);
            border-radius: 0.5rem;
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
            color: var(--text-light);
            font-size: 1em;
        }
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
            outline: none;
        }
         .form-input.invalid {
             border-color: var(--red-color);
         }
         .form-input:disabled {
             background-color: #e2e8f0;
             cursor: not-allowed;
         }
         :host(.dark) .form-input:disabled {
            background-color: #334155;
         }

        .input-label {
            display: block;
            font-size: 0.875em;
            font-weight: 500;
            color: var(--subtle-text-light);
            margin-bottom: 0.25rem;
            transition: color 0.3s;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .actions-container {
             padding-top: 1.5rem;
             border-top: 1px solid var(--border-light);
             transition: border-color 0.3s;
             margin-top: 2rem;
        }

        .button {
            width: 100%;
            font-weight: 600;
            padding: 0.875rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1em;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .button-primary {
            background-color: var(--primary-color);
            color: var(--primary-text);
        }
         .button-primary:hover:not(:disabled) {
             background-color: var(--primary-hover);
         }
        
        .button-green {
            background-color: var(--green-color);
            color: var(--primary-text);
        }
         .button-green:hover:not(:disabled) {
             background-color: var(--green-hover);
         }

        .button-slate {
            background-color: var(--slate-color);
            color: var(--primary-text);
        }
         .button-slate:hover:not(:disabled) {
             background-color: var(--slate-hover);
         }
        
        .post-score-actions {
             display: flex;
             flex-direction: column;
             gap: 1rem;
        }
         @media (min-width: 768px) {
             .post-score-actions {
                 flex-direction: row-reverse;
             }
         }

        .result-area {
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            transition: border-color 0.3s;
            margin-bottom: 2rem;
        }
        .result-area h2 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 0;
        }
        #resultScore {
            font-size: 2.5em;
            font-weight: 700;
            margin: 1rem 0;
        }
         #resultScore.high { color: var(--green-color); }
         #resultScore.medium { color: var(--yellow-color); }
         #resultScore.low { color: var(--red-color); }

        .result-area p {
            color: var(--subtle-text-light);
            transition: color 0.3s;
        }
        
        #validationMessage {
             text-align: center;
             margin-bottom: 1rem;
             font-weight: 500;
             min-height: 1.5rem;
        }
         #validationMessage.success { color: var(--green-color); }
         #validationMessage.error { color: var(--red-color); }

        .hidden {
            display: none !important;
        }
    </style>
    <div class="quiz-wrapper">
        <div class="container">
            <div class="quiz-card">
                <div class="quiz-header">
                    <span class="theme-toggle" title="Toggle Light/Dark Mode">
                        <span class="light-icon">☀️</span>
                        <span class="dark-icon hidden">🌙</span>
                    </span>
                    <h1>M6 Grammar Practice Test</h1>
                    <p>A random set of 20 questions based on your M6 Study Guide.</p>
                </div>

                <form id="quizForm">
                    <div id="resultArea" class="result-area hidden">
                        <h2 id="resultTitle">Your Score:</h2>
                        <p id="resultScore"></p>
                        <p id="resultMessage">You can try again with a new set of questions, or enter your information below to send your score.</p>
                    </div>

                    <fieldset id="studentInfoSection" class="hidden">
                        <legend>Student Information</legend>
                        <div>
                            <label for="nickname" class="input-label">Nickname</label>
                            <input type="text" id="nickname" name="nickname" class="form-input">
                        </div>
                        <div class="grid-container" style="margin-top: 1rem;">
                            <div>
                                <label for="homeroom" class="input-label">Homeroom</label>
                                <input type="text" id="homeroom" name="homeroom" class="form-input">
                            </div>
                            <div>
                                <label for="studentId" class="input-label">Student ID</label>
                                <input type="text" id="studentId" name="studentId" class="form-input">
                            </div>
                        </div>
                    </fieldset>

                    <div id="postScoreActions" class="hidden">
                        <p id="validationMessage"></p>
                        <div class="post-score-actions">
                             <button type="button" id="sendButton" class="button button-green">
                                Send Score to Teacher
                            </button>
                            <button type="button" id="tryAgainButton" class="button button-slate">
                                Try Again
                            </button>
                        </div>
                    </div>

                    <fieldset id="questionsSection">
                        <legend>Questions</legend>
                    </fieldset>

                    <div id="checkScoreContainer" class="actions-container">
                        <button type="submit" id="checkScoreButton" class="button button-primary">
                            Check My Score
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</template>

<script>
(function(){
    // --- Component Setup ---
    const mainContainer = document.getElementById('quiz-m6-grammar-feedback-container');
    if (!mainContainer) {
        console.error('Quiz container #quiz-m6-grammar-feedback-container not found.');
        return;
    }
    
    const template = document.getElementById('quiz-template-m6-grammar-feedback');
    if (!template) {
        console.error('Quiz template #quiz-template-m6-grammar-feedback not found.');
        return;
    }

    const shadow = mainContainer.attachShadow({ mode: 'open' });
    shadow.appendChild(template.content.cloneNode(true));
    
    // --- IMPORTANT: Submission URL ---
    const SCRIPT_URL = 'google script URL here'; // Replace with your actual Google Apps Script URL'; 
    
    // --- Element Selectors (scoped to the shadow DOM) ---
    const quizForm = shadow.getElementById('quizForm');
    const questionsSection = shadow.getElementById('questionsSection');
    const studentInfoSection = shadow.getElementById('studentInfoSection');
    const checkScoreButton = shadow.getElementById('checkScoreButton');
    const checkScoreContainer = shadow.getElementById('checkScoreContainer');
    const postScoreActions = shadow.getElementById('postScoreActions');
    const sendButton = shadow.getElementById('sendButton');
    const tryAgainButton = shadow.getElementById('tryAgainButton');
    const resultArea = shadow.getElementById('resultArea');
    const resultScore = shadow.getElementById('resultScore');
    const validationMessage = shadow.getElementById('validationMessage');
    const studentInputs = [shadow.getElementById('nickname'), shadow.getElementById('homeroom'), shadow.getElementById('studentId')];
    const themeToggle = shadow.querySelector('.theme-toggle');

    // --- Quiz Data and State Management ---
    const questionBank = [
        { question: "I'm going out with _____ friends of mine tonight.", options: ["any", "some", "no", "every"], answer: "some", explanation: "Use 'some' for positive statements about an unspecified amount or number." },
        { question: "We didn't buy _____ flowers.", options: ["some", "any", "a", "none"], answer: "any", explanation: "Use 'any' in negative statements." },
        { question: "Would you like _____ to eat?", options: ["anything", "something", "nothing", "everything"], answer: "something", explanation: "Use 'something' in offers and requests." },
        { question: "Have you seen _____ good movies recently?", options: ["some", "any", "no", "a lot"], answer: "any", explanation: "Use 'any' in questions about an unknown quantity." },
        { question: "She went out without _____ money.", options: ["any", "some", "her", "no"], answer: "any", explanation: "'Without' makes the sentence negative, so we use 'any'." },
        { question: "Are there _____ words you don't understand?", options: ["some", "a few", "any", "much"], answer: "any", explanation: "Use 'any' in questions to ask if something exists." },
        { question: "You can take _____ bus. They all go to the centre.", options: ["some", "a", "the", "any"], answer: "any", explanation: "Use 'any' to mean 'it doesn't matter which one'." },
        { question: "There's _____ at the door.", options: ["anybody", "nobody", "somebody", "everybody"], answer: "somebody", explanation: "Use 'somebody' in positive statements to refer to an unspecified person." },
        { question: "It was a public holiday, so there were _____ shops open.", options: ["any", "no", "none", "some"], answer: "no", explanation: "Use 'no' before a noun to mean 'not any'." },
        { question: "'How much money do you have?' '_____.'", options: ["No", "Any", "None", "Not"], answer: "None", explanation: "'None' is a pronoun used on its own to mean 'not any'." },
        { question: "This money is all yours. _____ of it is mine.", options: ["No", "Any", "None", "Some"], answer: "None", explanation: "Use 'none of' before a pronoun or determiner." },
        { question: "Sarah will have _____ trouble finding a job.", options: ["none", "any", "no", "not"], answer: "no", explanation: "Use 'no' as a determiner before the noun 'trouble'." },
        { question: "We cancelled the party because _____ of the people we invited could come.", options: ["any", "no", "none", "not"], answer: "none", explanation: "'None of' is used before 'the' + noun to indicate zero quantity." },
        { question: "I'm sorry, but there is _____ sugar left.", options: ["any", "no", "none", "not a"], answer: "no", explanation: "'No' is used as a determiner before the noun 'sugar'." },
        { question: "I don't have _____ pets.", options: ["no", "any", "none of", "some"], answer: "any", explanation: "Use 'any' in negative statements with 'do not' or 'does not'." },
        { question: "'How many questions did you get right?' '_____! I failed the test.'", options: ["Any", "No", "None", "Some"], answer: "None", explanation: "'None' is a pronoun that can be a complete answer by itself." },
        { question: "Is this book yours or _____?", options: ["my", "me", "mine", "I"], answer: "mine", explanation: "'Mine' is a possessive pronoun that can stand alone." },
        { question: "That's not my pen. This is _____ pen.", options: ["my", "mine", "me", "I"], answer: "my", explanation: "'My' is a possessive adjective used before a noun." },
        { question: "We went on holiday with some friends of _____.", options: ["we", "our", "us", "ours"], answer: "ours", explanation: "'Ours' is a possessive pronoun used after 'of' in the phrase 'a friend of ours'." },
        { question: "Why don't you use your _____ ideas?", options: ["own", "self", "by yourself", "one"], answer: "own", explanation: "'Your own' is used to emphasize possession." },
        { question: "Did you go on holiday on your _____?", options: ["own", "self", "alone", "by"], answer: "own", explanation: "'On your own' is an idiom meaning 'alone' or 'independently'." },
        { question: "The children made the decorations _____.", options: ["themself", "themselves", "theirselves", "them"], answer: "themselves", explanation: "'Themselves' is the reflexive pronoun for 'the children' (they)." },
        { question: "He cut _____ while he was shaving.", options: ["him", "hisself", "himself", "he"], answer: "himself", explanation: "Use the reflexive pronoun 'himself' because the subject ('he') and the object of the verb are the same person." },
        { question: "I like living by _____.", options: ["me", "my own", "myself", "my"], answer: "myself", explanation: "'By myself' is an idiom that means 'alone'." },
        { question: "Which sentence is punctuated correctly?", options: ["She speaks English, Thai and Spanish", "She speaks English Thai, and Spanish", "She speaks English, Thai, and Spanish.", "She speaks English, Thai, and, Spanish"], answer: "She speaks English, Thai, and Spanish.", explanation: "Use commas to separate items in a list. The comma before 'and' (the Oxford comma) is standard in formal writing." },
        { question: "Which punctuation mark should be used at the end of this sentence: 'How old are you'", options: [".", ",", "!", "?"], answer: "?", explanation: "Use a question mark (?) at the end of a direct question." },
        { question: "That looks amazing___", options: [".", ",", "!", "?"], answer: "!", explanation: "Use an exclamation mark (!) to show strong feeling or excitement." },
        { question: "Aomsin said___ 'Bam likes hanging out with her boyfriend.'", options: [":", ",", ";", "."], answer: ",", explanation: "Use a comma to introduce a direct quote after a verb like 'said'." },
        { question: "Taylor Swift sang, 'But I've got a blank space baby___ and I'll write your name.'", options: [",", ".", ";", ""], answer: ",", explanation: "A comma is needed here inside the quotation marks before the closing tag of the quote." },
        { question: "I needed to go for a walk___ also, I needed to buy milk.", options: [",", ".", ";", ":"], answer: ";", explanation: "A semicolon (;) can be used to connect two closely related independent clauses." },
        { question: "The US President___ Donald Trump___ came to Thailand.", options: ["( )", ", ,", "- -", "; ;"], answer: ", ,", explanation: "Use a pair of commas to set off an appositive, which is a noun or phrase that renames a nearby noun." },
        { question: "He asked___ 'Will you be my girlfriend___'", options: [", / ?", ". / .", "! / .", ", / ."], answer: ", / ?", explanation: "Use a comma before the quote and a question mark inside the quotation marks because the quote itself is a question." },
        { question: "Which sentence has correct capitalization?", options: ["tom loves dogs.", "Tom loves dogs.", "tom loves Dogs.", "Tom Loves Dogs."], answer: "Tom loves dogs.", explanation: "Capitalize the first word of a sentence and proper nouns (like names). 'Dogs' is a common noun." },
        { question: "Which sentence is correct?", options: ["i live in thailand.", "I live in Thailand.", "I live in thailand.", "i live in Thailand."], answer: "I live in Thailand.", explanation: "Always capitalize the pronoun 'I' and proper nouns like countries ('Thailand')." },
        { question: "My friend is from _____.", options: ["japan", "Japan", "JAPAN", "jaPan"], answer: "Japan", explanation: "Proper nouns, including countries, must be capitalized." },
        { question: "_____ you like dogs too?", options: ["do", "Do", "DO", "dO"], answer: "Do", explanation: "The first word of a sentence must always be capitalized." },
        { question: "He has _____ work to do.", options: ["any", "some", "none", "no"], answer: "some", explanation: "Use 'some' in positive statements for an unspecified amount." },
        { question: "_____ of the students passed the exam. It was very difficult.", options: ["No", "Any", "None", "Some"], answer: "None", explanation: "'None of' is used to indicate that zero out of a specific group did something." },
        { question: "The cat is washing _____.", options: ["it's", "its", "itself", "it"], answer: "itself", explanation: "Use the reflexive pronoun 'itself' because the cat is doing the action to its own body." },
        { question: "Choose the correct sentence.", options: ["She bought milk bread and eggs.", "She bought milk, bread, and eggs.", "she bought milk, bread, and eggs.", "She bought Milk, Bread, and Eggs."], answer: "She bought milk, bread, and eggs.", explanation: "Capitalize the first word of a sentence and use commas to separate items in a list." }
    ];

    const questionsPerQuiz = 20;
    let currentQuestions = [];
    let score = 0;
    let questionsAnswered = 0;

    // --- Utility Functions ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // --- Core Quiz Logic ---
    function generateQuiz() {
        questionsSection.innerHTML = '<legend>Questions</legend>';
        shuffleArray(questionBank);
        currentQuestions = questionBank.slice(0, questionsPerQuiz);
        score = 0;
        questionsAnswered = 0;
        checkScoreButton.disabled = true;

        currentQuestions.forEach((q, index) => {
            const questionId = `q${index}`;
            const shuffledOptions = [...q.options];
            shuffleArray(shuffledOptions);
            const optionsHtml = shuffledOptions.map(option => `
                <label class="option-label">
                    <input type="radio" name="${questionId}" value="${option}" class="form-radio" required>
                    <span>${option}</span>
                </label>
            `).join('');
            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block';
            questionBlock.innerHTML = `
                <p>${index + 1}. ${q.question}</p>
                <div class="options-group">${optionsHtml}</div>
                <div class="explanation-box hidden"></div>
            `;
            questionsSection.appendChild(questionBlock);
        });
    }

    function handleAnswer(e) {
        if (e.target.type !== 'radio' || e.target.dataset.answered) return;

        const selectedRadio = e.target;
        const questionBlock = selectedRadio.closest('.question-block');
        const questionIndex = parseInt(selectedRadio.name.replace('q', ''));
        const questionData = currentQuestions[questionIndex];
        const selectedValue = selectedRadio.value;
        const isCorrect = selectedValue === questionData.answer;

        if (isCorrect) {
            score++;
        }
        questionsAnswered++;

        const radioButtons = questionBlock.querySelectorAll(`input[name="${selectedRadio.name}"]`);
        radioButtons.forEach(radio => {
            const label = radio.closest('.option-label');
            radio.disabled = true;
            radio.dataset.answered = 'true';
            label.style.cursor = 'default';
            label.style.removeProperty('background-color');

            let feedbackIcon = label.querySelector('.feedback-icon');
            if (!feedbackIcon) {
                feedbackIcon = document.createElement('span');
                feedbackIcon.className = 'feedback-icon';
                label.appendChild(feedbackIcon);
            }

            if (radio.value === questionData.answer) {
                label.classList.add('correct');
                feedbackIcon.textContent = '✅';
            } else if (radio.checked) {
                label.classList.add('incorrect');
                feedbackIcon.textContent = '❌';
            }
        });
        
        // Show explanation
        const explanationBox = questionBlock.querySelector('.explanation-box');
        if (explanationBox) {
            explanationBox.innerHTML = `<strong>Explanation:</strong> ${questionData.explanation}`;
            explanationBox.classList.remove('hidden');
        }
        
        if (questionsAnswered === questionsPerQuiz) {
            checkScoreButton.disabled = false;
        }
    }

    function showFinalScore() {
        resultScore.textContent = `${score} / ${questionsPerQuiz}`;
        const scorePercentage = score / questionsPerQuiz;
        resultScore.className = '';
        if (scorePercentage >= 0.8) resultScore.classList.add('high');
        else if (scorePercentage >= 0.5) resultScore.classList.add('medium');
        else resultScore.classList.add('low');
        
        checkScoreContainer.classList.add('hidden');
        resultArea.classList.remove('hidden');
        studentInfoSection.classList.remove('hidden');
        postScoreActions.classList.remove('hidden');
        
        mainContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetQuiz() {
        quizForm.reset();
        resultArea.classList.add('hidden');
        studentInfoSection.classList.add('hidden');
        postScoreActions.classList.add('hidden');
        questionsSection.classList.remove('hidden');
        checkScoreContainer.classList.remove('hidden');
        validationMessage.textContent = '';
        studentInputs.forEach(input => {
            input.classList.remove('invalid');
            input.disabled = false;
        });
        sendButton.disabled = false;
        sendButton.textContent = 'Send Score to Teacher';
        tryAgainButton.disabled = false;
        generateQuiz();
        mainContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- Event Listeners ---
    questionsSection.addEventListener('change', handleAnswer);

    quizForm.addEventListener('submit', function(e) {
        e.preventDefault(); 
        showFinalScore();
    });

    sendButton.addEventListener('click', function() {
        let allFieldsValid = true;
        studentInputs.forEach(input => {
            if (input.value.trim() === '') {
                allFieldsValid = false;
                input.classList.add('invalid');
            } else {
                input.classList.remove('invalid');
            }
        });
        if (!allFieldsValid) {
            validationMessage.textContent = 'Please fill out all student information fields.';
            validationMessage.className = 'error';
            return;
        }
        validationMessage.textContent = '';
        sendButton.disabled = true;
        tryAgainButton.disabled = true;
        sendButton.textContent = 'Sending...';
        const studentData = {
            quizName: 'M6 Grammar Practice Test',
            nickname: shadow.getElementById('nickname').value,
            homeroom: shadow.getElementById('homeroom').value,
            studentId: shadow.getElementById('studentId').value,
            score: score,
            total: questionsPerQuiz,
            timestamp: new Date().toISOString()
        };
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            body: JSON.stringify(studentData)
        })
        .then(response => response.json())
        .then(data => {
            validationMessage.textContent = `✅ ${data.message || 'Submission successful!'}`;
            validationMessage.className = 'success';
            sendButton.textContent = 'Sent Successfully';
            studentInputs.forEach(input => input.disabled = true);
        })
        .catch((error) => {
            console.error('Error:', error);
            validationMessage.textContent = `⚠️ Error: Could not submit score. Please try again.`;
            validationMessage.className = 'error';
            sendButton.textContent = 'Try Sending Again';
            sendButton.disabled = false;
            tryAgainButton.disabled = false;
        });
        mainContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    tryAgainButton.addEventListener('click', resetQuiz);

    themeToggle.addEventListener('click', () => {
        shadow.host.classList.toggle('dark');
        const isDark = shadow.host.classList.contains('dark');
        shadow.querySelector('.light-icon').classList.toggle('hidden', isDark);
        shadow.querySelector('.dark-icon').classList.toggle('hidden', !isDark);
    });

    // --- Initial Load ---
    generateQuiz();
})();
</script>

</body>
</html>
